version: '3.8'

services:
  # ============ API Server ============
  api:
    build: .
    container_name: nano-banana-api
    ports:
      - "8000:8000"
    environment:
      # Application
      - ENVIRONMENT=production
      - DEBUG=false
      # Redis
      - REDIS_URL=redis://redis:6379/0
      # Google Gemini API
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      # Cloudflare R2 (optional)
      - R2_ENABLED=${R2_ENABLED:-false}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-nano-banana-images}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
      # GitHub OAuth (optional)
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      - GITHUB_REDIRECT_URI=${GITHUB_REDIRECT_URI}
      # Trial Mode (optional)
      - TRIAL_ENABLED=${TRIAL_ENABLED:-false}
      - TRIAL_GLOBAL_QUOTA=${TRIAL_GLOBAL_QUOTA:-50}
    volumes:
      - ./outputs:/app/outputs
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============ Redis ============
  redis:
    image: redis:7-alpine
    container_name: nano-banana-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ============ ARQ Worker (Task Queue) ============
  worker:
    build: .
    container_name: nano-banana-worker
    command: arq api.workers.WorkerSettings
    environment:
      - REDIS_URL=redis://redis:6379/0
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - R2_ENABLED=${R2_ENABLED:-false}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-nano-banana-images}
      - R2_PUBLIC_URL=${R2_PUBLIC_URL}
    volumes:
      - ./outputs:/app/outputs
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    # Worker doesn't expose ports, just processes background jobs

volumes:
  redis_data:
    driver: local

networks:
  default:
    name: nano-banana-network
