version: '3.8'

services:
  # ============ API Server ============
  api:
    build: .
    container_name: nano-banana-api
    ports:
      - "8888:8000"
    environment:
      # Application
      - ENVIRONMENT=production
      - DEBUG=false
      # Redis (host machine, DB 1 to avoid conflict)
      - REDIS_URL=redis://host.docker.internal:6379/1
      # PostgreSQL
      - DATABASE_ENABLED=true
      - DATABASE_URL=postgresql+asyncpg://prompthub:prompthub_dev@host.docker.internal:5432/idea_generator
      # Google Gemini API
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      # Auth Service
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - AUTH_SERVICE_URL=http://host.docker.internal:8100
      - AUTH_SERVICE_CLIENT_ID=${AUTH_SERVICE_CLIENT_ID}
      # Storage (MinIO on host)
      - MINIO_ENDPOINT=host.docker.internal:9000
      - STORAGE_PUBLIC_URL=http://localhost:9000/idea-generator
    volumes:
      - ./outputs:/app/outputs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============ ARQ Worker (Task Queue) ============
  worker:
    build: .
    container_name: nano-banana-worker
    command: arq api.workers.WorkerSettings
    environment:
      - REDIS_URL=redis://host.docker.internal:6379/1
      - DATABASE_ENABLED=true
      - DATABASE_URL=postgresql+asyncpg://prompthub:prompthub_dev@host.docker.internal:5432/idea_generator
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
    volumes:
      - ./outputs:/app/outputs
    restart: unless-stopped
    # Worker doesn't expose ports, just processes background jobs

networks:
  default:
    name: nano-banana-network
